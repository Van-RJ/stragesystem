<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>在庫管理システム</title>
    <link rel="icon" href="/stragesystem/favicon.png">
    <link href="index.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
        import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCJrTBegcg7tponcwM-t6Uhe6l6xS2AnOk",
          authDomain: "stragesystem-1fb6d.firebaseapp.com",
          projectId: "stragesystem-1fb6d",
          storageBucket: "stragesystem-1fb6d.firebasestorage.app",
          messagingSenderId: "549547541",
          appId: "1:549547541:web:b5b87f211aeb3c92e5a81c",
          measurementId: "G-JRMVM58B5H"
        };


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);

        Vue.component('board-list', {
            template: '<div class="container"><table class="board-list table is-striped is-fulwidth"><div style="font-size: 0.75rem;"><tr><td>{{date}}</td><td>{{name}}</td><td>{{message}}</td><td>{{amount}}</td></tr></div></div></tablr>',
            props: ['name', 'message', 'date', 'id', 'amount'],
        })

        Vue.component('board-form', {
            template: '<div class="form-area">Name : <input v-model="name"><br><p class="help is-danger" style="font-size: 15px;" v-if="seen">※名前が入力されていません</p><br>Notes:<br><textarea v-model="message"></textarea><br>Amount: <input v-model="amount" type="text"><br><button class="button is-link" v-on:click="doAdd">書き込む</button></div>',
            data: function () {
                return {
                    message: '',
                    name: '',
                    amount: '',
                    seen: true
                }
            },
            watch: {
                name(newVal) {
                    this.seen = newVal.trim() === '';
                }
            },

            methods: {
                doAdd: function () {
                    console.log('doAdd called:', this.name, this.message, this.amount)
                    this.$emit('input', this.name, this.message, this.amount)
                    this.name = ''
                    this.message = ''
                    this.amount = ''
                }
            }
        })

        var board = new Vue({
            el: '#board',
            data: {
                lists: [],
                user: null,
                authResolved: false
            },
            created: function () {
                var vue = this;

                onAuthStateChanged(auth, async (user) => {
                    console.log('Auth state changed:', user);
                    vue.authResolved = true;
                    console.log('authResolved;', vue.authResolved);

                    if (user) {
                        console.log('User logged in:', user.email);
                        
                        const allowedEmails = ['futo9999999@gmail.com'];
                        if (!allowedEmails.includes(user.email)) {
                            alert('許可されていないユーザーです。');
                            signOut(auth);
                            vue.user = null;
                            return;
                        }

                        vue.$set(vue, 'user', user);
                        console.log('User data set:', vue.user);

                        const boardCol = collection(db, 'board');

                        onSnapshot(boardCol, (snapshot) => {
                            const items = [];
                            snapshot.forEach(doc => {
                                items.push(doc.data());
                            });
                            vue.$set(vue, 'lists', items);
                        }, (error) => {
                            alert("データ取得エラー: " + error.message);
                        });
                    } else {
                        vue.$set(vue, 'user', null);
                        console.log('User loggedd out');
                    }
                })
            },
            methods: {
                doAdd: function (name, message, amount) {
                    console.log('parent doAdd called with:', name, message, amount)
                    var now = new Date();
                    addDoc(collection(db, 'board'), {
                        name: name,
                        message: message,
                        amount: amount,
                        date: now.getMonth() + 1 + '月' + now.getDate() + '日' + now.getHours() + '時' + now.getMinutes() + '分'
                    })
                    .then(() => console.log('addDoc succeeded'))
                    .catch(err => console.error('addDoc failed:', err));
                },

                signInWithGoogle: function () {
                    const provider = new GoogleAuthProvider();
                    signInWithPopup(auth, provider)
                        .then((result) => {
                            console.log("Logged in with Google:", result.user);
                        })
                        .catch((error) => {
                            console.error("Google login error:", error);
                        })
                }
                
            }
        })
    </script>
</head>
<body>
    <div id="board">
        <section class="hero" style="margin: 0; padding: 0; background-color: rgb(216, 216, 216);">
            <div class="hero-body is-small" style="padding: 1rem">
                <h1 class="board-title is-size-4 has-text-weight-bold">部品在庫管理</h1>
            </div>
        </section>
        <p v-if="!authResolved" class="has-text-grey">認証確認中...</p>
        <button @click="signInWithGoogle" class="button is-primary">Googleでログイン</button>
        <div v-if="authResolved && user">
            <p>ログイン中: {{ user.email }}</p>
            <p>ユーザー名: {{ user.displayName }}</p>
                <details id="frame"style="padding: 0.25rem; 0.4rem;">
                  <summary class="is-size-6" style="font-weight: bold;">トラブル情報</summary>
                  <p class="is-size-6">・今んとこない</p>
                </details>
            <!-- <ul class="lists" style="list-style-type: none"> -->
            <table class="table is-striped is-fulwidth">
                <board-list v-for="(list, key) in lists" :key="key" :name="list.name" :message="list.message" :date="list.date" :amount="list.amount"><table class="table is-striped is-fulwidth"></table></board-list>
            </table>
            <!-- </ul> -->
            <board-form v-on:input="doAdd"></board-form>
        </div>
    </div>
    <!-- <script src="index.js"></script> -->
</body>
</html>