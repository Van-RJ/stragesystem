<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>在庫管理システム</title>
        <link rel="icon" href="/stragesystem/favicon.png">
        <link href="index.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
            import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
            import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

            const firebaseConfig = {
                apiKey: "AIzaSyCJrTBegcg7tponcwM-t6Uhe6l6xS2AnOk",
                authDomain: "stragesystem-1fb6d.firebaseapp.com",
                projectId: "stragesystem-1fb6d",
                storageBucket: "stragesystem-1fb6d.firebasestorage.app",
                messagingSenderId: "549547541",
                appId: "1:549547541:web:b5b87f211aeb3c92e5a81c",
                measurementId: "G-JRMVM58B5H"
            };


            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const analytics = getAnalytics(app);
            const auth = getAuth(app);

            Vue.component('board-list', {
                template: '<tr><div style="font-size: 0.75rem;"><td>{{date}}</td><td>{{name}}</td><td>{{message}}</td><td>{{amount}}</td></div></tr>',
                props: ['name', 'message', 'date', 'id', 'amount']
            });

            Vue.component('board-form', {
                props: ['editItem'],
                template: '<div class="form-area">Name : <input v-model="name"><br><p class="help is-danger" style="font-size: 15px;" v-if="seen">※名前が入力されていません</p><br>Notes:<br><textarea v-model="message"></textarea><br>Amount: <input v-model="amount" type="text"><br><button class="button is-link" v-on:click="handleSubmit">{{ isEditing ? "反映" : "書き込む" }}</button> <button v-if="isEditing" class="button" v-on:click="cancelEdit">キャンセル</button></div>',
                data: function () {
                    return {
                        message: '',
                        name: '',
                        amount: '',
                        seen: true
                    };
                },
                computed: {
                    isEditing: function() {
                        return !!(this.editItem && this.editItem.id);
                    }
                },
                watch: {
                    name(newVal) {
                        this.seen = newVal.trim() === '';
                    },
                    editItem: function(newVal) {
                        if (newVal && newVal.id) {
                            this.name = newVal.name || '';
                            this.message = newVal.message || '';
                            this.amount = newVal.amount || '';
                        } else {
                            // clear when no edit item
                            this.name = '';
                            this.message = '';
                            this.amount = '';
                        }
                    }
                },

                methods: {
                    handleSubmit: function () {
                        if (this.isEditing) {
                            // emit save with id
                            this.$emit('save', this.editItem.id, this.name, this.message, this.amount);
                        } else {
                            console.log('doAdd called:', this.name, this.message, this.amount);
                            this.$emit('input', this.name, this.message, this.amount);
                        }
                        // clear local fields after action
                        this.name = '';
                        this.message = '';
                        this.amount = '';
                    },
                    cancelEdit: function() {
                        this.$emit('cancel');
                        this.name = '';
                        this.message = '';
                        this.amount = '';
                    }
                }
            });

            document.addEventListener('DOMContentLoaded', function() {
                var board = new Vue({
                    el: '#board',
                    data: {
                        lists: [],
                        user: null,
                        authResolved: false,
                        selectedId: null,
                        unsubscribeSnapshot: null,
                        editingItem: null
                    },
                    mounted: function() {
                        // register a global click listener to clear selection when clicking outside the data table
                        this._outsideClickHandler = (ev) => {
                            const tableEl = document.querySelector('.lists');
                            if (!tableEl) return;
                            // if click target is not inside the table, clear selection
                            if (!tableEl.contains(ev.target)) {
                                this.clearSelection();
                            }
                        };
                        document.addEventListener('click', this._outsideClickHandler);
                    },
                    beforeDestroy: function() {
                        // remove global listener
                        if (this._outsideClickHandler) {
                            document.removeEventListener('click', this._outsideClickHandler);
                            this._outsideClickHandler = null;
                        }
                        // unsubscribe Firestore snapshot listener if present
                        if (this.unsubscribeSnapshot && typeof this.unsubscribeSnapshot === 'function') {
                            try { this.unsubscribeSnapshot(); } catch(e) { console.warn('unsubscribeSnapshot failed', e); }
                            this.unsubscribeSnapshot = null;
                        }
                    },
                    created: function () {
                        var vue = this;

                        onAuthStateChanged(auth, async (user) => {
                            console.log('Auth state changed:', user);
                            vue.authResolved = true;
                            console.log('authResolved;', vue.authResolved);

                            if (user) {
                                console.log('User logged in:', user.email);

                                const allowedEmails = ['futo9999999@gmail.com'];
                                if (!allowedEmails.includes(user.email)) {
                                    alert('許可されていないユーザーです。');
                                    signOut(auth);
                                    vue.user = null;
                                    return;
                                }

                                vue.$set(vue, 'user', user);
                                console.log('User data set:', vue.user);

                                const boardCol = collection(db, 'board');

                                const unsub = onSnapshot(boardCol, (snapshot) => {
                                    const items = [];
                                    snapshot.forEach(doc => {
                                        items.push(Object.assign({ id: doc.id }, doc.data()));
                                    });
                                    vue.$set(vue, 'lists', items);
                                }, (error) => {
                                    alert("データ取得エラー: " + error.message);
                                });

                                // keep unsubscribe to stop listening on sign out if needed
                                vue.unsubscribeSnapshot = unsub;
                            } else {
                                vue.$set(vue, 'user', null);
                                console.log('User loggedd out');
                            }
                        })
                    },
                    methods: {
                        doAdd: function (name, message, amount) {
                            console.log('parent doAdd called with:', name, message, amount);
                            var now = new Date();
                            addDoc(collection(db, 'board'), {
                                name: name,
                                message: message,
                                amount: amount,
                                date: now.getMonth() + 1 + '月' + now.getDate() + '日' + now.getHours() + '時' + now.getMinutes() + '分'
                            })
                            .then(() => console.log('addDoc succeeded'))
                            .catch(err => console.error('addDoc failed:', err));
                        },

                        selectRow: function(id) {
                            this.selectedId = id;
                        },

                        startEdit: function(item) {
                            // copy item to avoid two-way binding issues
                            this.editingItem = Object.assign({}, item);
                            // also select the row
                            this.selectedId = item.id;
                        },

                        editSelected: function() {
                            if (!this.selectedId) {
                                alert('編集する行を先に選択してください。');
                                return;
                            }
                            const found = this.lists.find(l => l.id === this.selectedId);
                            if (!found) {
                                alert('選択項目が見つかりません。');
                                return;
                            }
                            this.startEdit(found);
                        },

                        saveEdited: async function(id, name, message, amount) {
                            try {
                                const ref = doc(db, 'board', id);
                                await updateDoc(ref, {
                                    name: name,
                                    message: message,
                                    amount: amount
                                });
                                console.log('updated', id);
                                this.editingItem = null;
                                this.selectedId = null;
                            } catch (err) {
                                console.error('update failed', err);
                                alert('更新に失敗しました。コンソールを確認してください。');
                            }
                        },

                        cancelEdit: function() {
                            this.editingItem = null;
                        },

                        clearSelection: function() {
                            this.selectedId = null;
                        },

                        deleteSelected: async function() {
                            if (!this.selectedId) return;
                            if (!confirm('選択中の項目を削除しますか？')) return;
                            try {
                                await deleteDoc(doc(db, 'board', this.selectedId));
                                console.log('deleted', this.selectedId);
                                this.selectedId = null;
                            } catch (err) {
                                console.error('delete failed', err);
                                alert('削除に失敗しました. コンソールを確認してください.');
                            }
                        },

                        signInWithGoogle: function () {
                            const provider = new GoogleAuthProvider();
                            signInWithPopup(auth, provider)
                                .then((result) => {
                                    console.log("Logged in with Google:", result.user);
                                })
                                .catch((error) => {
                                    console.error("Google login error:", error);
                                })
                        }
                    }
                });
            });
        </script>
    </head>
    <body>
        <div id="board">
            <section class="hero" style="margin: 0; padding: 0; background-color: rgb(216, 216, 216); color: rgb(43, 43, 43);">
                <div class="hero-body is-small" style="padding: 1rem">
                    <h1 class="board-title is-size-4 has-text-weight-bold">部品在庫管理</h1>
                </div>
            </section>
            <p v-if="!authResolved" class="has-text-grey">認証確認中...</p>
            <button @click="signInWithGoogle" class="button is-primary">Googleでログイン</button>
            <div v-if="authResolved && user">
                <p>ログイン中: {{ user.email }}</p>
                <p>ユーザー名: {{ user.displayName }}</p>
                <details id="frame" style="padding: 0.25rem 0.4rem; color: rgb(43, 43, 43);">
                    <summary class="is-size-6" style="font-weight: bold;">トラブル情報</summary>
                    <p class="is-size-6">・今んとこない</p>
                </details>
                <!-- <ul class="lists" style="list-style-type: none"> -->
                    <!-- <board-list v-for="(list, key) in lists" :key="key" :name="list.name" :message="list.message" :date="list.date" :amount="list.amount"></board-list> -->
                <!-- </ul> -->
                <div style="width:90%; margin:0 auto; display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <div style="display:flex; gap:8px;">
                        <button class="button is-warning" v-on:click="editSelected">編集</button>
                        <button class="button is-danger" v-on:click="deleteSelected">削除</button>
                    </div>
                </div>
                <table class="lists table is-striped is-fullwidth" style="width:90%; margin:0 auto;">
                    <thead>
                        <tr>
                            <th style="width:18%">日付</th>
                            <th style="width:18%">名前</th>
                            <th>メッセージ</th>
                            <th style="width:12%">数量</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="list in lists" :key="list.id" :class="{ 'is-selected': selectedId === list.id }">
                            <td v-on:click.stop="selectRow(list.id)">{{ list.date }}</td>
                            <td v-on:click.stop="selectRow(list.id)">{{ list.name }}</td>
                            <td v-on:click.stop="selectRow(list.id)">{{ list.message }}</td>
                            <td v-on:click.stop="selectRow(list.id)">{{ list.amount }}</td>
                        </tr>
                    </tbody>
                </table>
                <board-form :edit-item="editingItem" v-on:save="saveEdited" v-on:cancel="cancelEdit" v-on:input="doAdd"></board-form>
            </div>
        </div>
        <!-- <script src="index.js"></script> -->
    </body>
</html>